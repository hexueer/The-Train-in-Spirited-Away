<!doctype html>

<!--HWK6 - Creative Scene for CS307
    Author: Yihui Liao and Ivy Ho
    Date: 04/10/2022

-->

<html>
    <head>
        <meta charset="utf-8">
        <title>Creative Scene</title>
        <style>
            canvas {
                display: block;
                margin: 10px auto;
                width: 100%;
                height: 100%;
            }
        </style>

        <script src="https://cs.wellesley.edu/~cs307/threejs/libs/three-r95.all.js">
        "https://cs.wellesley.edu/~cs307/threejs/libs/three-r80.min.js"
        </script>
        <script src="https://cs.wellesley.edu/~cs307/threejs/libs/OrbitControls-r95.js">
        "https://cs.wellesley.edu/~cs307/threejs/libs/OrbitControls-r80.js"
        </script>
        <script src="https://cs.wellesley.edu/~cs307/threejs/libs/dat.gui-r95.js">
        "https://cs.wellesley.edu/~cs307/threejs/libs/dat.gui-r80.min.js"
        </script>
        <script src="https://cs.wellesley.edu/~cs307/threejs/libs/tw-sp21.js">
        "https://cs.wellesley.edu/~cs307/threejs/libs/tw-fa18.js"
        </script>
        <!-- Refer to https://sbcode.net/threejs/csg/ to understand the logic of ThreeBSP -->
        <script src="https://rawgit.com/Wilt/ThreeCSG/develop/ThreeCSG.js"></script>
    </head>
    <body>
        <script type="module">
            // import { Water } from 'https://threejs.org/examples/jsm/objects/Water.js';
            // import { Sky } from 'https://threejs.org/examples/jsm/objects/Sky.js';


            // create a scene
            var scene = new THREE.Scene();

            // ====================================================================
            // prepare for scene objects

            // object sizes
            var params = {
                groundDimension: 1000,
                plankHeight: .25,
				plankDepth: 5,
				plankWidth: 1,
				railZ: 1.5,
				railWidth: .25,
				railDepth: 3,
                
                // train car
                width: 15, // x
                height: 5, // y
                depth: 6, // z
                space: .25
            };

            var cameraParams = {
                    near: 1,
                    far: 100,
                    fov: 90,
                    aspectRatio: 800/500,
                    atX: params.groundDimension,
                    atY: 0,
                    atZ: 0,
                    eyeX: 0,
                    eyeY: 50,
                    eyeZ: 0,
                    upX: 0,
                    upY: 1,
                    upZ: 0
                  };

            // setupCamera() function creates and returns a camera with the desired parameters
            function setupCamera (cameraParameters) {
                // set up an abbreviation 
                var cp = cameraParameters;
                // create an initial camera with the desired shape
                var camera = new THREE.PerspectiveCamera(cp.fov, cp.aspectRatio, cp.near, cp.far);
                // set the camera location and orientation
                camera.position.set(cp.eyeX, cp.eyeY, cp.eyeZ);
                camera.up.set(cp.upX, cp.upY, cp.upZ);
                camera.lookAt(new THREE.Vector3(cp.atX, cp.atY, cp.atZ));
                return camera;
            }


            // prepare materials
            var materials;  
            var colorMaterials;                  
            TW.loadTextures(["rock.jpeg", "concrete.jpeg", "wood.jpg", "metal.jpg", "water.jpeg", "plank.jpeg", "sky.jpg"],
            function (textures) {
                adjustTexture(textures[0], 200, 2, false);
                adjustTexture(textures[1], 10, 3, false);
                adjustTexture(textures[2], 1, 1, false);
                adjustTexture(textures[3], 3, 1, false);
                adjustTexture(textures[4], 50, 50, false);
                adjustTexture(textures[5], 4, 1, false);
                adjustTexture(textures[6], 1, 1, false);


                materials = [new THREE.MeshPhongMaterial({color: 0xffffff,  // 0 rock
                                                        map: textures[0]}),
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 1 concrete
                                                        map: textures[1]}),
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 2 water
                                                        map: textures[4],
                                                        side: THREE.DoubleSide}), 
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 3 wood
                                                        map: textures[2]}),
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 4 metal
                                                        map: textures[3]}),   
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 5 red plank
                                                        map: textures[5]}),
                            new THREE.MeshPhongMaterial({color: 0xffffff,   // 6 sky
                                                        map: textures[6],
                                                        side: THREE.BackSide}),                      
                            ];

                colorMaterials = [new THREE.MeshPhongMaterial({color: new THREE.Color(0xfcce8e), // 0 beige
                                                        specular: new THREE.Color("dimgray"),
                                                        shininess: 5,
                                                        side: THREE.DoubleSide}),
                                new THREE.MeshPhongMaterial({color: new THREE.Color(0x4395A0), // 1 blue
                                                        specular: new THREE.Color("dimgray"),
                                                        shininess: 5,
                                                        side: THREE.DoubleSide}),   
                                new THREE.MeshPhongMaterial({color: new THREE.Color(0x000000), // 2 black
                                                        specular: new THREE.Color("dimgray"),
                                                        shininess: 5,
                                                        side: THREE.DoubleSide}),
                                new THREE.MeshPhysicalMaterial({color: new THREE.Color(0xffffff), // 3 white??
                                                        side: THREE.DoubleSide,
                                                        transparent: true,
                                                        opacity: .5,
                                                        roughness: 0,
                                                        reflectivity: 5,
                                                        }),   
                                new THREE.MeshPhongMaterial({color: new THREE.Color(0x730a00), // 4 red
                                                        side: THREE.DoubleSide}), 
                                ];
                remakeScene();
            });

            // ====================================================================
            // functions to create scene objects

            function adjustTexture(texture, repeatH, repeatV, mirror) {
                texture.repeat.set(repeatH,repeatV);
                texture.needsUpdate = true;
                if (mirror) {
                    texture.wrapS = THREE.MirroredRepeatWrapping;
                    texture.wrapT = THREE.MirroredRepeatWrapping;
                } else {
                    texture.wrapS = THREE.RepeatWrapping;
                    texture.wrapT = THREE.RepeatWrapping;
                }
            }

            function makeGround() {
                var ground = new THREE.Object3D();

                // blue plane for bottom of the sea
                var plane1 = new THREE.PlaneGeometry(params.groundDimension, params.groundDimension);
                var planeMesh1 = new THREE.Mesh(plane1, colorMaterials[1]);
                planeMesh1.rotation.x = Math.PI/2;
                ground.add(planeMesh1);

                // blue plane for top of the sea
                var plane2 = new THREE.PlaneGeometry(params.groundDimension, params.groundDimension);
                var planeMesh2 = new THREE.Mesh(plane2, materials[2]);
                planeMesh2.rotation.x = Math.PI/2;
                planeMesh2.position.y = .5;
                
                // enable transparency
                planeMesh2.material.transparent = true;
                // set opacity to 50%
                planeMesh2.material.opacity = 0.5; 
                ground.add(planeMesh2);

                // rock path
                var path = new THREE.PlaneGeometry(params.groundDimension, params.groundDimension/100);

                var pathMesh = new THREE.Mesh(path, materials[0]);
                pathMesh.position.y = 0.01;
                pathMesh.rotation.x = Math.PI/2;
                pathMesh.material.side = THREE.DoubleSide;

                ground.add(pathMesh);

                // train tracks
                var positionX = -200;
                for (let i = 0; i <= 200; i++ ){
                    var track = makeTracks();
                    track.position.x = positionX + params.railDepth/2;
                    positionX += params.railDepth/2;
                    ground.add(track);
                }
                
                return ground;
            }

            function makeTracks(){
                var track = new THREE.Object3D();
                
				var height = params.plankHeight;
				var depth = params.plankDepth;
				var width = params.plankWidth;
				var railZ = params.railZ;

				var plankGeom = new THREE.BoxGeometry(width,height,depth);
				var plankMesh = new THREE.Mesh(plankGeom, materials[3]);

				var rail1 = makeRail();
				var rail2 = makeRail();

				rail1.position.z = railZ;
				rail2.position.z = -railZ;

				track.add(plankMesh)
				track.add(rail1);
				track.add(rail2);

				return track;
            }

            function makeRail(){
				var width = params.railWidth;
				var height = params.plankHeight;
				var depth = params.railDepth;

				var railGeom = new THREE.BoxGeometry(width, height, depth);
				var railMesh = new THREE.Mesh(railGeom, materials[4]);

				railMesh.position.y = height;
				railMesh.rotation.y = Math.PI/2;

				return railMesh;
			}

            function makeTrainCar(width, height, depth, material) {
                var car = new THREE.Object3D();

                var carGeom = makeTrainCarGeom(width, height, depth, 0, 0, 0);
                var bsp_carGeom = addWindowHoles(carGeom, width, height);
                bsp_carGeom = addWheelHoles(bsp_carGeom, width, height, depth);
                var carInsideGeom = makeTrainCarGeom(width, height-0.5, depth-0.5, 0.1, 0, 0);
                bsp_carGeom = bsp_carGeom.subtract(carInsideGeom);  // remove inside of train
                var carMesh = makeMesh(bsp_carGeom, material);
                car.add(carMesh);

                // add red planking to the side of the train cars
                var planking = makeTrainCarShape(params.width+0.15, params.height/2, params.depth+0.15, materials[5], true);
                planking.position.x = -0.1;
                car.add(planking);

                return car;
            }

            // returns a train car ThreeBSP geometry by merging a box and cylinder into one geometry
            // uses offset to adjust location of geometry before becoming ThreeBSP
            function makeTrainCarGeom(width, height, depth, offsetX, offsetY, offsetZ){
                var carGeom = new THREE.Geometry();
       
                // main length of box car and cylinder head
                var boxGeom = new THREE.BoxGeometry(width, height, depth);
                var cylinderGeom = new THREE.CylinderGeometry(depth/2, depth/2, height, 100);

                // align them 
                boxGeom.translate(width/2 + offsetX, height/2 + offsetY, offsetZ);
                cylinderGeom.translate(width + offsetX, height/2 + offsetY, offsetZ);

                // use ThreeBSP to union geometries
                var bsp_boxGeom = new ThreeBSP(boxGeom);
                var bsp_cylinderGeom = new ThreeBSP(cylinderGeom);

                return bsp_boxGeom.union(bsp_cylinderGeom);
            }

            // takes a train car BSP geometry and adds windows but subtracting boxes from the car
            function addWindowHoles(bspGeom, width, height) {
                var windowGeom = new THREE.BoxGeometry(height/4, height/4, height*1.5);
                windowGeom.translate( -0.65, height/1.35, 0 );

                var bsp_window;
                // cut out all the windows
                for (let i = 0; i < 12; i++) {
                    windowGeom.translate( 1.5, 0, 0 );
                    bsp_window = new ThreeBSP(windowGeom);
                    bspGeom = bspGeom.subtract(bsp_window);
                }

                return bspGeom;
            }

            // takes a geometry and material and returns the mesh
            // method of producing the mesh varies depending on whether the geometry is 
            // a regular THREE geometry or a ThreeBSP geometry (has been hollowed out)
            function makeMesh(geom, material) {
                var mesh = geom.toMesh();
                mesh.material = material;

                return mesh;
            }

            // makes two wheel holes for the train car in the shape of trapezoids
            function addWheelHoles(carGeom, width, height, depth) {
                // wheel hole is the shape of a trapezoid
                var trapezoidGeom = new THREE.CylinderGeometry( width/8-1, width/8, height/6, 4, 1 );
                trapezoidGeom.rotateY( Math.PI / 4 );
                trapezoidGeom.scale( 1, 1, depth );
                trapezoidGeom.translate(width/3, height/12, 0);

                // add first whole
                var bsp_trapezoid = new ThreeBSP(trapezoidGeom);
                carGeom = carGeom.subtract(bsp_trapezoid);

                // add second whole
                trapezoidGeom.translate(width/1.5, 0, 0);
                var bsp_trapezoid = new ThreeBSP(trapezoidGeom);
                carGeom = carGeom.subtract(bsp_trapezoid);

                return carGeom;
            }
            
            function makeTrainCarShape(width, height, depth, material, hollow){
                var shapeGeom = makeTrainCarGeom(width, height, depth, 0, 0, 0);

                if (hollow) {
                    var shapeInsideGeom = makeTrainCarGeom(width, height-0.5, depth-0.5, 0.1, 0.5, 0);
                    shapeGeom = shapeGeom.subtract(shapeInsideGeom);  // remove inside of train
                    shapeGeom = addWheelHoles(shapeGeom, width, height, depth); // make wheel holes
                }

                var shapeMesh = makeMesh(shapeGeom, material);

                return shapeMesh;
            }

            function makeTrain(){
                var train = new THREE.Object3D();

                var space = params.space;
                // make two base car geometries
                var car1 = makeTrainCar(params.width, params.height, params.depth, colorMaterials[0]);
                var car2 = makeTrainCar(params.width, params.height, params.depth, colorMaterials[0]);
                car1.position.x = space;
                car2.position.x = -space;
                car2.rotation.y = Math.PI;

                train.add(car1);
                train.add(car2);

                var connector = addConnector();

                train.add(connector);


                //train top

                var top1 = makeTrainCarShape(params.width, .5, params.depth, colorMaterials[4]);
                var top2 = makeTrainCarShape(params.width, .5, params.depth, colorMaterials[4]);
                top2.rotation.y = Math.PI;

                top1.position.y = params.height;
                top1.position.x = space;

                top2.position.y = params.height;
                top2.position.x = -space;
    
                train.add(top1);
                train.add(top2);

                //windows

                var window1 = makeTrainCarShape(params.width, params.height, params.depth - .1, colorMaterials[3]);
                var window2 = makeTrainCarShape(params.width, params.height, params.depth - .1, colorMaterials[3]);

                window2.rotation.y = Math.PI;

                window1.position.x = space;
                window2.position.x = -space;

                train.add(window1);
                train.add(window2);

                //cylinder top

                var cylinder1 = makeTrainTopCylinder(1.5, .5, colorMaterials[4]);
                cylinder1.position.y = params.height + .5;
                cylinder1.position.x = params.width;

                var cylinder2 = makeTrainTopCylinder(1.5, .5, colorMaterials[4]);
                cylinder2.position.y = params.height + .5;
                cylinder2.position.x = -params.width;

                train.add(cylinder1);
                train.add(cylinder2);

                var cylinder3 = makeTrainTopCylinder(1.5, .5, colorMaterials[4]);
                cylinder3.position.y = params.height + .5;
                cylinder3.position.x = 3;

                var cylinder4 = makeTrainTopCylinder(1.5, .5, colorMaterials[4]);
                cylinder4.position.y = params.height + .5;
                cylinder4.position.x = -3;

                train.add(cylinder3);
                train.add(cylinder4);

                //cylinder long top

                var cylinderLong1 = makeTrainTopCylinderLong(2, 1.5, .5, colorMaterials[4]);
                cylinderLong1.position.y = params.height + .5;
                cylinderLong1.position.x = 9;

                var cylinderLong2 = makeTrainTopCylinderLong(3, 1.5, .5, colorMaterials[4]);
                cylinderLong2.position.y = params.height + .5;
                cylinderLong2.position.x = -9;

                train.add(cylinderLong1);
                train.add(cylinderLong2);

                //add spotlight

                var spotlight1 = makeSpotlight(.5, 1, 1, 1, colorMaterials[0], colorMaterials[4], 1);
                spotlight1.position.y = params.height;
                spotlight1.position.x = params.width + params.depth/2;

                var light1 = new THREE.SpotLight(0xffffff, 1, 0, TW.degrees2radians(20), 0, 1);
                light1.position.set(params.width + params.depth/2, params.height, 0);
                light1.target.position.set(30, 0, 0);

                var spotlight2 = makeSpotlight(.5, 1, 1, 1, colorMaterials[0], colorMaterials[4], -1);
                spotlight2.position.y = params.height;
                spotlight2.position.x = - params.width - params.depth/2;

                var light2 = new THREE.SpotLight(0xffffff, 1, 0, TW.degrees2radians(20), 0, 1);
                light2.position.set(-params.width - params.depth/2, params.height, 0);
                light2.target.position.set(-30, 0, 0);

                scene.add(light1);
                scene.add(light1.target);
                scene.add(light2);
                scene.add(light2.target)

                train.add(spotlight1);
                train.add(spotlight2);

                return train;
            }

            // function makeWindow(side){

            //     var window = new THREE.Object3D();

            //     var planeGeom = new THREE.PlaneGeometry(2, 2);
            //     var planeMesh = new THREE.Mesh(planeGeom, colorMaterials[3]);

            //     planeMesh.position.z = side * (params.depth/2 + .1);
            //     planeMesh.position.y = params.height - 2;

            //     window.add(planeMesh);

            //     return window;
            // }

            function makeSpotlight(radius, width, height, depth, coneMaterial, boxMaterial, side){

                var spotlight = new THREE.Object3D();

                var boxGeom = new THREE.BoxGeometry(width, height, depth);
                var boxMesh = new THREE.Mesh(boxGeom, boxMaterial);

                boxMesh.position.y = height/2;

                var coneGeom = new THREE.ConeGeometry(radius, width, 64, 1, true);
                var coneMesh = new THREE.Mesh(coneGeom, coneMaterial);

                coneMesh.rotation.z = side * Math.PI/2;
                coneMesh.position.x = side * .5;
                coneMesh.position.y = width/2;

                var sphereGeom = new THREE.SphereGeometry(radius/2, 32, 16 );
                var sphereMesh = new THREE.Mesh(sphereGeom, colorMaterials[3]);

                sphereMesh.position.x = side * .5;
                sphereMesh.position.y = width/2;
                
                spotlight.add(boxMesh);
                spotlight.add(coneMesh);
                spotlight.add(sphereMesh);

                return spotlight;
                
            }

            function makeTrainTopCylinder(radius, height, material){

                var cylinder = new THREE.Object3D();
                
                var cylinderGeom = new THREE.CylinderGeometry(radius, radius, height, 20);
                var cylinderMesh = new THREE.Mesh(cylinderGeom, material);
                cylinderMesh.position.y = height/2;
                cylinder.add(cylinderMesh);

                return cylinder;
            }

            function makeTrainTopCylinderLong(width, radius, height, material){

                var cylinderLong = new THREE.Object3D();

                var cylinder1 = makeTrainTopCylinder(radius, height, material);
                var cylinder2 = makeTrainTopCylinder(radius, height, material);

                cylinder1.position.x = width/2;
                cylinder2.position.x = -width/2;

                // var cylinderGeom1 = new THREE.CylinderGeometry(radius, radius, height, 20);
                // var cylinderMesh1 = new THREE.Mesh(cylinderGeom1, material);
                // cylinderMesh1.position.y = height/2;
                // cylinderMesh1.position.x = width/2;
                // cylinderLong.add(cylinderMesh1);

                // var cylinderGeom2 = new THREE.CylinderGeometry(radius, radius, height, 20);
                // var cylinderMesh2 = new THREE.Mesh(cylinderGeom2, material);
                // cylinderMesh2.position.y = height/2;
                // cylinderMesh2.position.x = -width/2;
                // cylinderLong.add(cylinderMesh2);

                var boxGeom = new THREE.BoxGeometry(width, height, radius * 2);
                var boxMesh = new THREE.Mesh(boxGeom, material);
                boxMesh.position.y = height/2;

                cylinderLong.add(boxMesh);
                cylinderLong.add(cylinder1);
                cylinderLong.add(cylinder2);

                return cylinderLong;
            }

            function makeWindowEnds(side){

                var window = new THREE.Object3D();

                var cylinderGeom = new THREE.CylinderGeometry(5, 5, 20, 32);
                // var cylinderGeom = 
            }

            function addConnector(){

                var connector = new THREE.Object3D();

                var space = params.space;
                var width = space * 2 - .1;
                var height = params.height - .5;
                var depth = params.depth - .5;

                var boxGeom = new THREE.BoxGeometry(width, height, depth);
                var boxMesh = new THREE.Mesh(boxGeom, colorMaterials[2]);
                boxMesh.position.y = height/2;

                connector.add(boxMesh);

                return connector;
            }


            // make train station platform
            function makePlatform() {
                // make plane size relative to ground size
                var dimension = params.groundDimension;
                var platHeight = 1;

                var platGeom = new THREE.CylinderGeometry( dimension/200, dimension/160, platHeight, 4, 1 );
                platGeom.rotateY( Math.PI / 4 );
                platGeom.scale( 6, 1, 1 );
                // var platGeom = new THREE.BoxGeometry(dimension/50, platHeight, dimension/200);
                var platMesh = new THREE.Mesh(platGeom, materials[1])
                platMesh.position.set(-20, platHeight/2 + 0.01, -params.plankDepth*2); // add a little extra on y so it doesn't glitch

                return platMesh;
            }


            function makeSphere(){
                var sphereGeom = new THREE.SphereGeometry(100, 32, 16);
                var sphereMesh = new THREE.Mesh(sphereGeom, materials[6]);

                return sphereMesh;
            }


            // function test(width, height, depth, material) {
            //     var car = new THREE.Object3D();

            //     var carGeom = makeTrainCarGeom(width, height, depth, 0, 0, 0);
            //     var bsp_carGeom = addWindowHoles(carGeom, width, height);
            //     bsp_carGeom = addWheelHoles(bsp_carGeom, width, height, depth);
            //     var carInsideGeom = makeTrainCarGeom(width, height-0.5, depth-0.5, 0.1, 0, 0);
            //     bsp_carGeom = bsp_carGeom.subtract(carInsideGeom);  // remove inside of train
            //     var carMesh = makeMesh(bsp_carGeom, material);
            //     car.add(carMesh);

            //     // add red planking to the side of the train cars
            //     var planking = makeTrainCarShape(params.width+0.15, params.height/2, params.depth+0.15, materials[5], true);
            //     planking.position.x = -0.1;
            //     car.add(planking);

            //     return car;
            // }

            // render the scene
            function remakeScene() {
                var ground = makeGround();
                scene.add(ground);

                var plat = makePlatform();
                scene.add(plat);

                var train = makeTrain();
                train.position.y = 0.5;
                scene.add(train);

                var sphere = makeSphere();
                scene.add(sphere);

                // var testMesh = test(params.width, params.height, params.depth, colorMaterials[0]);
                // testMesh.position.y = 10;
                // scene.add(testMesh);

                TW.render();
            }


            // ====================================================================
            // add objects to the scene

            
            // ====================================================================
            // make lights

            // 55% intensity
            var ambLight = new THREE.AmbientLight(new THREE.Color("white"), 0.55);
            scene.add(ambLight);
            
            // directional light coming from slightly right, front, and up direction
            var dirLight = new THREE.DirectionalLight( TW.WHITE, 0.7 );
            dirLight.position.set( 0.7, 0.9, 1 );
            // dirLight.position.set(0, 5, 10);
            scene.add(dirLight);

            // ====================================================================
            // set up renderer
            var renderer = new THREE.WebGLRenderer();

            TW.mainInit(renderer,scene);

            // create camera, add to scene, and render scene with new camera
            function renderNewFrame() {
                var camera = setupCamera(cameraParams);
                scene.add(camera);
                renderer.render(scene,camera);
            }

            // set up default camera
            TW.cameraSetup(renderer,
                            scene,
                            {minx: -10, maxx: 10,
                            miny: 0, maxy: 10,
                            minz: -10, maxz: 10});

            // ====================================================================

        </script>
    </body>
</html>